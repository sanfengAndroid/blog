

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/images/favicon-32x32.png">
  <link rel="icon" href="/blog/images/favicon-32x32.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="sanfengAndroid">
  <meta name="keywords" content="Android安全,Android逆向,AntiOllvm">
  
    <meta name="description" content="前言我们知道linux系统中存在 LD_PRELOAD 环境变量更改库的链接顺序，影响库的导入函数重定位，而Android使用linux是内核也包含 LD_PRELOAD环境变量，具体使用路径在 linker_main.cpp 中(本文分析源码如未特别提及则都基于最新主分支)。在执行linker初始化时访问了该环境变量，后续优先加载将其作为全局库从而影响之后该进程加载的所有库的符号链接，因此后续我">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 动态修改Linker实现LD_PRELOAD全局库PLT Hook">
<meta property="og:url" content="https://sanfengandroid.github.io/blog/2021/01/10/modify-linker-to-implement-plt-hook/">
<meta property="og:site_name" content="sanfengAndroid逆向安全">
<meta property="og:description" content="前言我们知道linux系统中存在 LD_PRELOAD 环境变量更改库的链接顺序，影响库的导入函数重定位，而Android使用linux是内核也包含 LD_PRELOAD环境变量，具体使用路径在 linker_main.cpp 中(本文分析源码如未特别提及则都基于最新主分支)。在执行linker初始化时访问了该环境变量，后续优先加载将其作为全局库从而影响之后该进程加载的所有库的符号链接，因此后续我">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-01-10T12:37:48.000Z">
<meta property="article:modified_time" content="2021-01-18T03:36:49.699Z">
<meta property="article:author" content="sanfengAndroid">
<meta property="article:tag" content="Android源码">
<meta property="article:tag" content="Android Hook">
<meta property="article:tag" content="PLT Hook">
<meta name="twitter:card" content="summary_large_image">
  
  
  <title>Android 动态修改Linker实现LD_PRELOAD全局库PLT Hook - sanfengAndroid逆向安全</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"sanfengandroid.github.io","root":"/blog/","version":"1.8.14","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":1280777274,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/blog/local-search.xml"};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/blog/">
      <strong>sanfengAndroid逆向安全</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/sanfengAndroid">
                <i class="iconfont icon-github-fill"></i>
                Github
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Android 动态修改Linker实现LD_PRELOAD全局库PLT Hook">
              
                Android 动态修改Linker实现LD_PRELOAD全局库PLT Hook
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-01-10 20:37" pubdate>
        2021年1月10日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      47k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      395 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Android 动态修改Linker实现LD_PRELOAD全局库PLT Hook</h1>
            
            <div class="markdown-body">
              <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们知道linux系统中存在 <code>LD_PRELOAD</code> 环境变量更改库的链接顺序，影响库的导入函数重定位，而Android使用linux是内核也包含 <code>LD_PRELOAD</code>环境变量，具体使用路径在 <a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:bionic/linker/linker_main.cpp;l=352">linker_main.cpp</a> 中(本文分析源码如未特别提及则都基于最新主分支)。在执行<code>linker</code>初始化时访问了该环境变量，后续优先加载将其作为全局库从而影响之后该进程加载的所有库的符号链接，因此后续我们将围绕该环境变量展开</p>
<a id="more"></a>

<h2 id="环境变量的初始化、获取、修改"><a href="#环境变量的初始化、获取、修改" class="headerlink" title="环境变量的初始化、获取、修改"></a>环境变量的初始化、获取、修改</h2><p>环境变量的获取：获取环境变量使用libc中的<code>getenv</code>方法，而其中使用的全局变量声明为<code>extern &quot;C&quot; char** environ;</code>，该导出符号在<code>libc.so</code>库中，因此我们也可以通过<code>dlsym(libchandler, &quot;environ&quot;)</code>来遍历当前进程的所有环境变量。</p>
<p>环境变量的修改：调用libc中的<code>putenv</code>，如果不存在则添加，存在则会替换为新值</p>
<p>环境变量的初始化：在<code>linker_main.cpp</code>文件中的<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:bionic/linker/linker_main.cpp;l=318">linker_main</a>方法中有调用<code>__libc_init_AT_SECURE(args.envp)</code>，该函数具体代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">void</span> __libc_init_AT_SECURE(<span class="hljs-keyword">char</span>** env) &#123;<br>  <span class="hljs-comment">// Check that the kernel provided a value for AT_SECURE.</span><br>  errno = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> is_AT_SECURE = getauxval(AT_SECURE);<br>  <span class="hljs-keyword">if</span> (errno != <span class="hljs-number">0</span>) __early_abort(__LINE__);<br><br>  <span class="hljs-comment">// Always ensure that STDIN/STDOUT/STDERR exist. This prevents file</span><br>  <span class="hljs-comment">// descriptor confusion bugs where a parent process closes</span><br>  <span class="hljs-comment">// STD*, the exec()d process calls open() for an unrelated reason,</span><br>  <span class="hljs-comment">// the newly created file descriptor is assigned</span><br>  <span class="hljs-comment">// 0&lt;=FD&lt;=2, and unrelated code attempts to read / write to the STD*</span><br>  <span class="hljs-comment">// FDs.</span><br>  <span class="hljs-comment">// In particular, this can be a security bug for setuid/setgid programs.</span><br>  <span class="hljs-comment">// For example:</span><br>  <span class="hljs-comment">// https://www.freebsd.org/security/advisories/FreeBSD-SA-02:23.stdio.asc</span><br>  <span class="hljs-comment">// However, for robustness reasons, we don&#x27;t limit these protections to</span><br>  <span class="hljs-comment">// just security critical executables.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Init is excluded from these protections unless AT_SECURE is set, as</span><br>  <span class="hljs-comment">// /dev/null and/or /sys/fs/selinux/null will not be available at</span><br>  <span class="hljs-comment">// early boot.</span><br>  <span class="hljs-keyword">if</span> ((getpid() != <span class="hljs-number">1</span>) || is_AT_SECURE) &#123;<br>    __nullify_closed_stdio();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (is_AT_SECURE) &#123;<br>    __sanitize_environment_variables(env);<br>  &#125;<br><br>  <span class="hljs-comment">// Now the environment has been sanitized, make it available.</span><br>  environ = __libc_shared_globals()-&gt;init_environ = env;<br><br>  __initialize_personality();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>该函数初始化了<code>environ</code>全局变量，但是该初始化很明显是在<code>linker</code>可执行文件内初始化的跟我们上面所说的在<code>libc.so</code>中不同，且这个时候还根本没有装载<code>libc.so</code>这个库，这就要看<code>__libc_shared_globals()</code>是如何返回的，查找申明结果查找到两个，一个是在<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:bionic/libc/bionic/libc_init_dynamic.cpp;l=159;drc=master;bpv=1;bpt=1">libc_init_dynamic.cpp</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> libc_shared_globals* __loader_shared_globals();<br>__LIBC_HIDDEN__ libc_shared_globals* __libc_shared_globals() &#123;<br>  <span class="hljs-keyword">return</span> __loader_shared_globals();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>一个是在<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:bionic/libc/bionic/libc_init_static.cpp;drc=master;bpv=1;bpt=1;l=329">libc_init_static.cpp</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++">__LIBC_HIDDEN__ libc_shared_globals* __libc_shared_globals() &#123;<br>  <span class="hljs-keyword">static</span> libc_shared_globals globals;<br>  <span class="hljs-keyword">return</span> &amp;globals;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看出第一个是调用一个外部函数，而第二个是直接返回静态变量，这是因为<code>libc</code>编译成静态库<code>libc.a</code>使用<code>libc_init_static</code>，编译成动态库<code>libc.so</code>使用<code>libc_init_dynamic</code>，因此<code>libc.so</code>中并不存在<code>__libc_shared_globals</code>方法的实现，使用IDA分析<code>libc.so</code>也可发现<code>__libc_shared_globals</code>是导入函数。那么谁实现了该函数呢，正是 <code>linker</code> 实现了该函数并导出该符号，使用IDA分析 <code>linker</code> 可发现该导出函数。因为 <code>linker</code> 模块本身要使用一些<code>libc</code>函数，而它本身又作为动态链接器无法依赖其它库，因此自身静态链接了一份<code>libc</code>，所以上面使用<code>getenv</code>实际上是访问了<code>linker</code>中局部静态变量<code>globals</code>数据</p>
<p>环境变量的值设置：上述初始化环境变量使用<code>__libc_init_AT_SECURE(args.envp)</code>，<code>args.envp</code>正是该环境变量，函数调用向上回溯<code>__linker_init_post_relocation()</code>，继续向上回溯<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:bionic/linker/linker_main.cpp;l=661;bpv=0;bpt=1">__linker_init()</a>，该函数是 <code>linker</code> 的入口函数，其有关环境变量设置代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> ElfW(Addr) __linker_init(<span class="hljs-keyword">void</span>* raw_args) &#123;<br>  <span class="hljs-comment">// Initialize TLS early so system calls and errno work.</span><br>  <span class="hljs-comment">// args中包含后续使用的环境变量</span><br>  <span class="hljs-function">KernelArgumentBlock <span class="hljs-title">args</span><span class="hljs-params">(raw_args)</span></span>;<br>  bionic_tcb temp_tcb __attribute__((uninitialized));<br>  linker_memclr(&amp;temp_tcb, <span class="hljs-keyword">sizeof</span>(temp_tcb));<br>  __libc_init_main_thread_early(args, &amp;temp_tcb);<br><br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/master:bionic/libc/private/KernelArgumentBlock.h;drc=master;bpv=0;bpt=1;l=30">KernelArgumentBlock</a>源码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;elf.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;link.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/auxv.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;platform/bionic/macros.h&quot;</span></span><br><br><span class="hljs-comment">// When the kernel starts the dynamic linker, it passes a pointer to a block</span><br><span class="hljs-comment">// of memory containing argc, the argv array, the environment variable array,</span><br><span class="hljs-comment">// and the array of ELF aux vectors. This class breaks that block up into its</span><br><span class="hljs-comment">// constituents for easy access.</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KernelArgumentBlock</span> &#123;</span><br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">KernelArgumentBlock</span><span class="hljs-params">(<span class="hljs-keyword">void</span>* raw_args)</span> </span>&#123;<br>    <span class="hljs-keyword">uintptr_t</span>* args = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">uintptr_t</span>*&gt;(raw_args);<br>    argc = <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">int</span>&gt;(*args);<br>    argv = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">char</span>**&gt;(args + <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// 此处初始化环境变量</span><br>    envp = argv + argc + <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// Skip over all environment variable definitions to find the aux vector.</span><br>    <span class="hljs-comment">// The end of the environment block is marked by a NULL pointer.</span><br>    <span class="hljs-keyword">char</span>** p = envp;<br>    <span class="hljs-keyword">while</span> (*p != <span class="hljs-literal">nullptr</span>) &#123;<br>      ++p;<br>    &#125;<br>    ++p; <span class="hljs-comment">// Skip the NULL itself.</span><br><br>    auxv = <span class="hljs-keyword">reinterpret_cast</span>&lt;ElfW(<span class="hljs-keyword">auxv_t</span>)*&gt;(p);<br>  &#125;<br><br>  <span class="hljs-comment">// Similar to ::getauxval but doesn&#x27;t require the libc global variables to be set up,</span><br>  <span class="hljs-comment">// so it&#x27;s safe to call this really early on.</span><br>  <span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getauxval</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> type)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (ElfW(<span class="hljs-keyword">auxv_t</span>)* v = auxv; v-&gt;a_type != AT_NULL; ++v) &#123;<br>      <span class="hljs-keyword">if</span> (v-&gt;a_type == type) &#123;<br>        <span class="hljs-keyword">return</span> v-&gt;a_un.a_val;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">int</span> argc;<br>  <span class="hljs-keyword">char</span>** argv;<br>  <span class="hljs-keyword">char</span>** envp;<br>  ElfW(<span class="hljs-keyword">auxv_t</span>)* auxv;<br><br> <span class="hljs-keyword">private</span>:<br>  BIONIC_DISALLOW_COPY_AND_ASSIGN(KernelArgumentBlock);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>查看源码可知原来环境变量紧跟着可执行程序参数<code>argv</code>后面，而可执行文件都是通过<code>exec</code>簇函数调用，最终都进行系统调用 <code>int execve(const char* __file, char* const* __argv, char* const* __envp);</code> 该环境变量默认是继承的父进程</p>
<h2 id="如何设置LD-PRELOAD环境变量"><a href="#如何设置LD-PRELOAD环境变量" class="headerlink" title="如何设置LD_PRELOAD环境变量"></a>如何设置LD_PRELOAD环境变量</h2><p>上面分析通过 <code>putenv</code> 方法确实可以添加<code>LD_PRELOAD</code>环境变量，但是在本进程中执行时机太晚，因为 <code>linker</code> 在启动的时候才获取<code>LD_PRELOAD</code>环境变量，后面就算是设置成功但是也不会触发了，那如何才能生效呢，有以下几种方法</p>
<ol>
<li>在该进程的父进程设置该环境变量，然后再启动该进程，根据继承关系得到该环境变量，由于Android特性所有应用进程都是<code>zygote</code>的子进程，似乎设置<code>zygote</code>进程环境变量比较完美，但实际情况并非如此，见下面分析</li>
<li>使用<code>exec</code>簇函数手动设置程序启动的环境变量，Android Java层<code>Runtime.exec</code>设置环境变量就是使用该方法，只是是<code>fork</code>子进程后在子进程调用<code>exec</code>簇函数</li>
<li>使用<a target="_blank" rel="noopener" href="https://developer.android.google.cn/ndk/guides/wrap-script?hl=en">Wrap shell script</a>以全新进程运行程序，参考官网解释</li>
</ol>
<p>接下来分析每种方式，我们的目的是在Hook每个App中的函数。</p>
<ol>
<li>方式1针对非Apk执行（如直接执行可执行文件)等可行，而这相当于在shell中设置环境变量或使用<code>Runtime.exec</code>执行。而正常Apk执行是要经过<code>zygote</code>进程<code>fork</code>，看似在<code>zygote</code>进程设置然后所有APP进程都继承，虽然如此但执行时机已经太晚，因为APP进程从<code>zygote</code>进程<code>fork</code>下来其<code>linker</code>已经初始化执行过了，且<code>zygote</code>连Java环境都已经准备好还预加载了一些代码和资源，因此后续不会在获取<code>LD_PRELOAD</code>环境变量，有关源码如下 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-function"><span class="hljs-keyword">private</span> Runnable <span class="hljs-title">handleChildProc</span><span class="hljs-params">(ZygoteArguments parsedArgs,</span></span><br><span class="hljs-function"><span class="hljs-params">            FileDescriptor pipeFd, <span class="hljs-keyword">boolean</span> isZygote)</span> </span>&#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        * By the time we get here, the native code has closed the two actual Zygote</span><br><span class="hljs-comment">        * socket connections, and substituted /dev/null in their place.  The LocalSocket</span><br><span class="hljs-comment">        * objects still need to be closed properly.</span><br><span class="hljs-comment">        */</span><br><br>        closeSocket();<br><br>        Zygote.setAppProcessName(parsedArgs, TAG);<br><br>        <span class="hljs-comment">// End of the postFork event.</span><br>        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>        <span class="hljs-keyword">if</span> (parsedArgs.mInvokeWith != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">// 不为null则是第三种Wrap shell script情况</span><br>            WrapperInit.execApplication(parsedArgs.mInvokeWith,<br>                    parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,<br>                    VMRuntime.getCurrentInstructionSet(),<br>                    pipeFd, parsedArgs.mRemainingArgs);<br><br>            <span class="hljs-comment">// Should not get here.</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;WrapperInit.execApplication unexpectedly returned&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (!isZygote) &#123;<br>                <span class="hljs-comment">// 这里直接执行初始化跳转至ActivityThread执行</span><br>                <span class="hljs-keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,<br>                        parsedArgs.mDisabledCompatChanges,<br>                        parsedArgs.mRemainingArgs, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* classLoader */</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> ZygoteInit.childZygoteInit(parsedArgs.mTargetSdkVersion,<br>                        parsedArgs.mRemainingArgs, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* classLoader */</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br><span class="hljs-function">Runnable <span class="hljs-title">processOneCommand</span><span class="hljs-params">(ZygoteServer zygoteServer)</span> </span>&#123;<br>        String[] args;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            args = Zygote.readArgumentList(mSocketReader);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;IOException on command socket&quot;</span>, ex);<br>        &#125;<br><br>        ...略<br><br>        pid = Zygote.forkAndSpecialize(parsedArgs.mUid, parsedArgs.mGid, parsedArgs.mGids,<br>                parsedArgs.mRuntimeFlags, rlimits, parsedArgs.mMountExternal, parsedArgs.mSeInfo,<br>                parsedArgs.mNiceName, fdsToClose, fdsToIgnore, parsedArgs.mStartChildZygote,<br>                parsedArgs.mInstructionSet, parsedArgs.mAppDataDir, parsedArgs.mIsTopApp,<br>                parsedArgs.mPkgDataInfoList, parsedArgs.mWhitelistedDataInfoList,<br>                parsedArgs.mBindMountAppDataDirs, parsedArgs.mBindMountAppStorageDirs);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// in child</span><br>                zygoteServer.setForkChild();<br><br>                zygoteServer.closeServerSocket();<br>                IoUtils.closeQuietly(serverPipeFd);<br>                serverPipeFd = <span class="hljs-keyword">null</span>;<br><br>                <span class="hljs-keyword">return</span> handleChildProc(parsedArgs, childPipeFd, parsedArgs.mStartChildZygote);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span><br>                <span class="hljs-comment">// handleParentProc.</span><br>                IoUtils.closeQuietly(childPipeFd);<br>                childPipeFd = <span class="hljs-keyword">null</span>;<br>                handleParentProc(pid, serverPipeFd);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            IoUtils.closeQuietly(childPipeFd);<br>            IoUtils.closeQuietly(serverPipeFd);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
 当然还可在<code>init</code>进程设置环境变量，<code>zygote</code>从<code>init</code>进程<code>fork</code>下来则继承该环境变量</li>
<li>使用<code>Runtime.exec</code>执行，该情况的弊端在于本进程无法生效，后续子进程生效，而正常情况APP内执行<code>Runtime.exec</code>也只是启动<code>shell</code>执行一些短暂脚本，因此APK进程并不会被Hook。使用<code>exec</code>簇函数在当前进程执行，那完全是替换当前进程，该方式与方法3是相同道理，只是方法3执行时机是在<code>zygote</code>进程<code>fork</code>后立即执行，而本方式是在<code>App</code>执行自身代码时才能执行，相当于二次重启APP，但在实际APK执行却无法成功</li>
<li>使用<code>Wrap shell script</code>执行，通过文档其最基本脚本如下   <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/system/bin/sh</span><br><span class="hljs-built_in">exec</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br></code></pre></td></tr></table></figure>
 通过执行<code>shell</code>脚本内部也是调用<code>exec</code>簇函数，官方文档<a target="_blank" rel="noopener" href="https://developer.android.google.cn/ndk/guides/wrap-script#packaging_wrapsh">打包wrap.sh</a>也要求APK必须是可调试的<code>android:debuggable=&quot;true&quot;</code>，还要设置<code>android:extractNativeLibs=&quot;true&quot;</code>以及将<code>wrap.sh</code>打包到原生库中，这些参数作为启动参数传递给<code>zygote</code>，在<code>Zygote.java</code>中有如下代码 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyInvokeWithSystemProperty</span><span class="hljs-params">(ZygoteArguments args)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (args.mInvokeWith == <span class="hljs-keyword">null</span>) &#123;<br>        args.mInvokeWith = getWrapProperty(args.mNiceName);<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getWrapProperty</span><span class="hljs-params">(String appName)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (appName == <span class="hljs-keyword">null</span> || appName.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    String propertyValue = SystemProperties.get(<span class="hljs-string">&quot;wrap.&quot;</span> + appName);<br>    <span class="hljs-keyword">if</span> (propertyValue != <span class="hljs-keyword">null</span> &amp;&amp; !propertyValue.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> propertyValue;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
 也就是可以设置全局属性<code>wrap.apppackage</code>来指定<code>Wrap shell script</code>脚本位置方便我们测试。接着上面<code>handleChildProc</code>函数分析，当<code>parsedArgs.mInvokeWith != null</code>执行<code> WrapperInit.execApplication</code>源码如下 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs Java"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execApplication</span><span class="hljs-params">(String invokeWith, String niceName,</span></span><br><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">int</span> targetSdkVersion, String instructionSet, FileDescriptor pipeFd,</span></span><br><span class="hljs-function"><span class="hljs-params">        String[] args)</span> </span>&#123;<br>    StringBuilder command = <span class="hljs-keyword">new</span> StringBuilder(invokeWith);<br><br>    <span class="hljs-keyword">final</span> String appProcess;<br>    <span class="hljs-keyword">if</span> (VMRuntime.is64BitInstructionSet(instructionSet)) &#123;<br>        appProcess = <span class="hljs-string">&quot;/system/bin/app_process64&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        appProcess = <span class="hljs-string">&quot;/system/bin/app_process32&quot;</span>;<br>    &#125;<br>    command.append(<span class="hljs-string">&#x27; &#x27;</span>);<br>    command.append(appProcess);<br><br>    <span class="hljs-comment">// Generate bare minimum of debug information to be able to backtrace through JITed code.</span><br>    <span class="hljs-comment">// We assume that if the invoke wrapper is used, backtraces are desirable:</span><br>    <span class="hljs-comment">//  * The wrap.sh script can only be used by debuggable apps, which would enable this flag</span><br>    <span class="hljs-comment">//    without the script anyway (the fork-zygote path).  So this makes the two consistent.</span><br>    <span class="hljs-comment">//  * The wrap.* property can only be used on userdebug builds and is likely to be used by</span><br>    <span class="hljs-comment">//    developers (e.g. enable debug-malloc), in which case backtraces are also useful.</span><br>    command.append(<span class="hljs-string">&quot; -Xcompiler-option --generate-mini-debug-info&quot;</span>);<br><br>    command.append(<span class="hljs-string">&quot; /system/bin --application&quot;</span>);<br>    <span class="hljs-keyword">if</span> (niceName != <span class="hljs-keyword">null</span>) &#123;<br>        command.append(<span class="hljs-string">&quot; &#x27;--nice-name=&quot;</span>).append(niceName).append(<span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    command.append(<span class="hljs-string">&quot; com.android.internal.os.WrapperInit &quot;</span>);<br>    command.append(pipeFd != <span class="hljs-keyword">null</span> ? pipeFd.getInt$() : <span class="hljs-number">0</span>);<br>    command.append(<span class="hljs-string">&#x27; &#x27;</span>);<br>    command.append(targetSdkVersion);<br>    Zygote.appendQuotedShellArgs(command, args);<br>    preserveCapabilities();<br>    Zygote.execShell(command.toString());<br>&#125;<br></code></pre></td></tr></table></figure>
 也就是将我们的<code>Wrap shell script</code>当作shell执行参数，其展开命令如下 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sh -c mywrap.sh /system/bin/app_process64 -Xcompiler-option --generate-mini-debug-info /system/bin --application --nice-name=App包名 com.android.internal.os.WrapperInit pipeFd 手机SDK版本 android.app.ActivityThread seq=数字<br></code></pre></td></tr></table></figure>
 其中 <code>android.app.ActivityThread seq=数字</code> 是启动Apk传递过来的参数<code>args</code>，回过头来方式2使用<code>exec</code>构造该执行参数即可。这种方式从<code>app_process</code>启动Apk与启动Java程序类似，只是相应参数，uid，Java环境不同，Apk包含Android上下文而Java程序则不包含。使用<code>app_process</code>执行必然又会需要动态链接，因此重新运行<code>linker</code>使我们设置的环境变量生效。因此我们可以修改<code>Wrap shell script</code>脚本如下 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/system/bin/sh</span><br><span class="hljs-built_in">export</span> LD_PRELOAD=/data/<span class="hljs-built_in">local</span>/tmp/ld-test.so<br><span class="hljs-built_in">exec</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br></code></pre></td></tr></table></figure>
 设置全局属性<code>setprop wrap.app.package path/to/mywrap.sh</code>,或者直接设置属性<code>setprop wrap.app.package LD_PRELOAD=/data/local/tmp/ld-test.so</code>根据shell命令展开都能生效，<strong>注意预加载so库的位数要与APP位数匹配，脚本和so的执行权限和selinux属性</strong></li>
</ol>
<p>三种方式都有其优劣势，方式1如果在<code>init</code>进程设置环境变量，那么<code>zygote</code>就会包含，进而传染给所有APP，但是同样所有APP都被Hook无法指定APP生效，且修改难度大。方式2使用<code>exec</code>子进程生效而本进程由于执行时机较晚不会成功。方式3则有更多的权限限制及打包限制。</p>
<h2 id="测试-LD-PRELOAD"><a href="#测试-LD-PRELOAD" class="headerlink" title="测试 LD_PRELOAD"></a>测试 LD_PRELOAD</h2><p>方式1 <code>init</code>进程注入其结果显而易见且操作困难（解锁<code>boot.img</code>，修改<code>init</code>/<code>启动脚本.rc</code>等总之要在很早的时机拿到执行权限，可以通过<code>Magisk</code>实现，这里不做讲解，当然也可以重新编译源码模拟测试）因此不做测试。</p>
<p>方式2 <code>Runtime.exec</code>子进程生效不做测试</p>
<p>方式3 设置<code>Wrap shell script</code>测试如下，为了方便直接设置全局属性<code>wrap.app.package=mywrap.sh</code>预加载库<code>ld-test.so</code>源码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;android/log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;hook_module.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> C_API extern <span class="hljs-meta-string">&quot;C&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUBLIC_METHOD __attribute__ ((visibility (<span class="hljs-meta-string">&quot;default&quot;</span>)))</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGD(format, ...) __android_log_print(ANDROID_LOG_DEBUG, <span class="hljs-meta-string">&quot;PreloadTest&quot;</span>, format, ##__VA_ARGS__);</span><br><br><span class="hljs-function">C_API PUBLIC_METHOD <span class="hljs-keyword">int</span> <span class="hljs-title">access</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *pathname, <span class="hljs-keyword">int</span> mode)</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">int</span> <span class="hljs-params">(*orig_access)</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *pathname, <span class="hljs-keyword">int</span> mode)</span> </span>= <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-keyword">if</span> (orig_access == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">void</span> *libc = dlopen(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (libc == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        orig_access = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">int</span> (*)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">int</span>)&gt;(dlsym(libc, <span class="hljs-string">&quot;access&quot;</span>));<br>        <span class="hljs-keyword">if</span> (orig_access == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 避免陷入死循环,高版本调用__android_log_print会访问access函数请求/dev/socket/logdw权限</span><br>    <span class="hljs-comment">// 因此此时再调用__android_log_print则会陷入死循环</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;/dev/socket/logdw&quot;</span>, pathname) == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">return</span> orig_access(pathname, mode);<br>    &#125;<br>    LOGD(<span class="hljs-string">&quot;Hook模块监听access函数,路径: %s, mode: %d&quot;</span>, pathname, mode);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;/data/local/tmp/ld-test.txt&quot;</span>, pathname) == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-comment">// 如果是我们测试文件访问则返回-1没有该文件</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> orig_access(pathname, mode);<br>&#125;<br><br><span class="hljs-keyword">static</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Init</span><span class="hljs-params">()</span> </span>&#123;<br>    LOGD(<span class="hljs-string">&quot;LD_PRELOAD模块被加载&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Java相关源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> org.sfandroid.nativehook.test;<br><br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.util.Log;<br><span class="hljs-keyword">import</span> android.view.View;<br><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-keyword">import</span> org.sfandroid.nativehook.test.databinding.ActivityMainBinding;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">View</span>.<span class="hljs-title">OnClickListener</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> ActivityMainBinding binding;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.loadLibrary(<span class="hljs-string">&quot;native-lib&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br><br>        binding = ActivityMainBinding.inflate(getLayoutInflater());<br>        setContentView(binding.getRoot());<br>        findViewById(R.id.btn_test).setOnClickListener(<span class="hljs-keyword">this</span>);<br>        findViewById(R.id.btn_test1).setOnClickListener(<span class="hljs-keyword">this</span>);<br>        <span class="hljs-comment">// Example of a call to a native method</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title">stringFromJNI</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execShell</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClick</span><span class="hljs-params">(View v)</span> </span>&#123;<br>        <span class="hljs-keyword">switch</span> (v.getId()) &#123;<br>            <span class="hljs-keyword">case</span> R.id.btn_test:<br><span class="hljs-comment">//                stringFromJNI();</span><br>                Log.d(<span class="hljs-string">&quot;PreloadTest&quot;</span>, <span class="hljs-string">&quot;文件存在: &quot;</span> + <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/data/local/tmp/ld-test.txt&quot;</span>).exists());<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> R.id.btn_test1:<br>                <span class="hljs-keyword">try</span> &#123;<br>                    execShell();<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>                    Log.e(<span class="hljs-string">&quot;PreloadTest&quot;</span>, <span class="hljs-string">&quot;执行错误&quot;</span>, e);<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>使用Android11官方x86_64模拟器，测试64位，将预加载库库放至<code>/data/local/tmp</code>目录下，并创建<code>data/local/tmp/ld-test.txt</code>测试文件，关闭<code>selinux</code>方便后续测试，命令如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">adb root<br>adb push path/to/ld-test.so /data/<span class="hljs-built_in">local</span>/tmp<br>adb shell touch /data/<span class="hljs-built_in">local</span>/tmp/ld-test.txt<br>adb shell chmod 777 /data/<span class="hljs-built_in">local</span>/tmp/libld-test.so<br>adb shell chmod 666 /data/<span class="hljs-built_in">local</span>/tmp/ld-test.txt<br>adb shell setenforce 0<br></code></pre></td></tr></table></figure>
<p>当我们未设置<code>wrap.org.sfandroid.nativehook.test</code>属性时执行测试结果如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-number">7667</span><span class="hljs-number">-7667</span><span class="hljs-string">/?</span> <span class="hljs-attr">D/PreloadTest:</span> <span class="hljs-string">文件存在:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<p>上面我们创建了测试文件因此它是真实存在的而当我们执行<code>adb shell setprop wrap.org.sfandroid.nativehook.test &quot;LD_PRELOAD=/data/local/tmp/libld-test.so&quot;</code>后重新运行APP测试结果如下</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: Hook模块监听access函数,路径: <span class="hljs-regexp">/dev/u</span>random, mode: <span class="hljs-number">4</span><br><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: Hook模块监听access函数,路径: <span class="hljs-regexp">/dev/</span>__properties__/property_info, mode: <span class="hljs-number">4</span><br><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: LD_PRELOAD模块被加载<br><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: Hook模块监听access函数,路径: <span class="hljs-regexp">/dev/</span>boringssl<span class="hljs-regexp">/selftest/</span><span class="hljs-number">1</span>cca4bc9f53317a49929af0b9283b0f20d38a542739d7db04ff0aa7ca9b9dcd1, mode: <span class="hljs-number">0</span><br><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: Hook模块监听access函数,路径: <span class="hljs-regexp">/dev/</span>boringssl<span class="hljs-regexp">/selftest/</span><span class="hljs-number">1</span>cca4bc9f53317a49929af0b9283b0f20d38a542739d7db04ff0aa7ca9b9dcd1, mode: <span class="hljs-number">0</span><br><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: Hook模块监听access函数,路径: <span class="hljs-regexp">/vendor/</span>overlay, mode: <span class="hljs-number">0</span><br><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: Hook模块监听access函数,路径: <span class="hljs-regexp">/vendor/</span>overlay<span class="hljs-regexp">/config/</span>config.xml, mode: <span class="hljs-number">0</span><br><br>...省略部分<br><br><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: Hook模块监听access函数,路径: <span class="hljs-regexp">/data/</span>local<span class="hljs-regexp">/tmp/</span>ld-test.txt, mode: <span class="hljs-number">0</span><br><span class="hljs-number">7806</span>-<span class="hljs-number">7806</span><span class="hljs-regexp">/? D/</span>PreloadTest: 文件存在: <span class="hljs-keyword">false</span><br></code></pre></td></tr></table></figure>
<p>可以看到<code>libld-test.so</code>确实被首先加载，并影响了Java层调用<code>File.exist</code>（native层调用access函数）结果，从而达到屏蔽的效果。</p>
<p>我们尝试了<code>wrap.sh</code>脚本方式需要设置环境变量或指定打包那么再测试一下直接构造<code>exec</code>执行参数试试，跟踪<code>Zygote.exeShell</code>最终调用<code>execv</code>函数，而它<code>return execve(name, argv, environ);</code>，因此只需要将<code>LD_PRELOAD</code>添加到当前进程环境变量然后调用<code>execv</code>函数即可，有关native代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span><br>JNIEXPORT <span class="hljs-keyword">void</span> JNICALL<br>Java_org_sfandroid_nativehook_test_MainActivity_execShell(JNIEnv *env, jobject thiz) &#123;<br>    <span class="hljs-keyword">char</span> *ld_preload = getenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ld_preload != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-comment">// 已经包含了LD_PRELOAD环境变量则不用再执行了</span><br>        LOGD(<span class="hljs-string">&quot;已经存在LD_PRELOAD变量: %s&quot;</span>, ld_preload);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    putenv((<span class="hljs-keyword">char</span> *) <span class="hljs-string">&quot;LD_PRELOAD=/data/local/tmp/libld-test.so&quot;</span>);<br>    <span class="hljs-comment">// pipeFd是开机后的一个socket文件写入，只要不重启该值不会变，为了方便本次设备为40固定即可</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *args[] = &#123;<span class="hljs-string">&quot;/system/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>,<br>                          <span class="hljs-string">&quot;/system/bin/app_process64 -Xcompiler-option --generate-mini-debug-info /system/bin --application --nice-name=org.sfandroid.nativehook.test com.android.internal.os.WrapperInit 40 30 android.app.ActivityThread seq=130&quot;</span>,<br>                          <span class="hljs-literal">nullptr</span>&#125;;<br>    execv(args[<span class="hljs-number">0</span>], (<span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> *) args);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这就相当于手动执行<code>wrap.sh</code>脚本，只是时间在App应用执行时，原理虽然通过但是执行却得到以下结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">596-789/? W/InputDispatcher: channel <span class="hljs-string">&#x27;7c0090b org.sfandroid.nativehook.test/org.sfandroid.nativehook.test.MainActivity (server)&#x27;</span> ~ Consumer closed input channel or an error occurred.  events=0x9<br>596-789/? E/InputDispatcher: channel <span class="hljs-string">&#x27;7c0090b org.sfandroid.nativehook.test/org.sfandroid.nativehook.test.MainActivity (server)&#x27;</span> ~ Channel is unrecoverably broken and will be disposed!<br>596-2056/? I/system_server: oneway <span class="hljs-keyword">function</span> results will be dropped but finished with status OK and parcel size 4<br>0-0/? I/binder: undelivered TRANSACTION_COMPLETE<br>0-0/? I/binder: undelivered transaction 858386, process died.<br>9687-9687/? D/PreloadTest: Hook模块监听access函数,路径: /dev/urandom, mode: 4<br>9687-9687/? D/PreloadTest: Hook模块监听access函数,路径: /dev/__properties__/property_info, mode: 4<br>9687-9687/? D/PreloadTest: LD_PRELOAD模块被加载<br>9687-9687/? D/PreloadTest: Hook模块监听access函数,路径: /system/bin/app_process64, mode: 1<br>596-2930/? I/WindowManager: WIN DEATH: Window&#123;7c0090b u0 org.sfandroid.nativehook.test/org.sfandroid.nativehook.test.MainActivity&#125;<br>596-2930/? W/InputDispatcher: Attempted to unregister already unregistered input channel <span class="hljs-string">&#x27;7c0090b org.sfandroid.nativehook.test/org.sfandroid.nativehook.test.MainActivity (server)&#x27;</span><br>596-2921/? I/ActivityManager: Process org.sfandroid.nativehook.test (pid 9687) has died: <span class="hljs-built_in">fg</span>  TOP <br>9687-9687/? I/sh: <span class="hljs-built_in">type</span>=1400 audit(0.0:180): avc: denied &#123; execute &#125; <span class="hljs-keyword">for</span> path=<span class="hljs-string">&quot;/data/local/tmp/libld-test.so&quot;</span> dev=<span class="hljs-string">&quot;dm-5&quot;</span> ino=65540 scontext=u:r:untrusted_app:s0:c153,c256,c512,c768 tcontext=u:object_r:shell_data_file:s0 tclass=file permissive=1 app=org.sfandroid.nativehook.test<br>300-300/? I/Zygote: Process 9687 exited due to signal 9 (Killed)<br>596-2056/? I/system_server: oneway <span class="hljs-keyword">function</span> results will be dropped but finished with status OK and parcel size 4<br>0-0/? I/init: Untracked pid 9723 received signal 9<br>596-2921/? W/ActivityTaskManager: Force removing ActivityRecord&#123;c639d07 u0 org.sfandroid.nativehook.test/.MainActivity t34&#125;: app died, no saved state<br><br></code></pre></td></tr></table></figure>
<p><code>ActivityManager: Process org.sfandroid.nativehook.test (pid 9687) has died: fg  TOP </code>最终进程会死亡被<code>kill</code>掉，当然你有可能看不到<code>PreloadTest: LD_PRELOAD模块被加载</code>该日志，因为进程过早就被杀死掉了，多次尝试可能会查看到（我也试了很多次才出现），这证明<code>exec</code>执行确实我们的环境变量已生效，只是因为其它原因被杀死而已。这与<code>wrap.sh</code>方式相同只是执行时机一个在<code>zygote fork</code>后就执行，一个在APP启动后才执行，而之所以被杀也不难猜测，因为APP环境全部都准备好的<code>system_server</code>里已经包含该APP的进程信息，而我们执行<code>execv</code>又把这些数据给清除掉了，这理所当然会被<code>system_server</code>认为APP可能已经死亡了因此被杀死。而在<code>zygote fork</code>后执行该APP环境根本还未执行，<code>system_server</code>没有它的记录，因此可以成功。具体原因可以分析源码，这里就不分析了，因为这离我们主题更远，且我们不走这条路径。</p>
<p>综上分析可实现的路径要么在父进程设置子进程生效要么就设置<code>Wrap shell script</code>，而我们针对APP指定进程生效最简单方法是设置<code>wrap.app.package</code>全局属性，但同时也需要root权限，注入<code>init</code>进程太麻烦也无法指定APP生效。即使<code>LD_PRELOAD</code>生效我们也无法在Hook模块内拦截<code>dlopen,dlsym</code>等函数，因为我们Hook模块内部要使用它获取原函数地址，就算自己实现<code>dlopen,dlsym</code>函数但是在Android7.0以上的命名空间限制<code>caller</code>的地址都变成我们的Hook模块内的地址，那么跨命名空间调用就会存在问题。</p>
<p>经过以上分析引入了我们本文章的主题 <strong>动态修改Linker实现LD_PRELOAD效果</strong> 该方式避免了上面的缺点，优点如下</p>
<ol>
<li>APP进程内生效，可以指定进程</li>
<li>可以重打包到APP内部无需权限，也可进程注入</li>
<li>可以HOOK指定模块（如<code>libandroid-runtime.so</code>等）</li>
<li>可以Hook <code>dlopen,dlsym</code>等符号，不受命名空间限制</li>
<li>进程<code>fork</code>子进程默认继承</li>
</ol>
<h2 id="LD-PRELOAD原理分析"><a href="#LD-PRELOAD原理分析" class="headerlink" title="LD_PRELOAD原理分析"></a><code>LD_PRELOAD</code>原理分析</h2><p>上面已经分析过在<code>linker_main</code>函数中获取该环境变量，紧接着往下分析</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Addr)</span> <span class="hljs-title">linker_main</span><span class="hljs-params">(KernelArgumentBlock&amp; args, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* exe_to_load)</span> </span>&#123;<br>  ...省略<br>  <br>  <span class="hljs-keyword">if</span> (!getauxval(AT_SECURE)) &#123;<br>    ldpath_env = getenv(<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ldpath_env != <span class="hljs-literal">nullptr</span>) &#123;<br>      INFO(<span class="hljs-string">&quot;[ LD_LIBRARY_PATH set to \&quot;%s\&quot; ]&quot;</span>, ldpath_env);<br>    &#125;<br>    <span class="hljs-comment">// 获取该环境变量</span><br>    ldpreload_env = getenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ldpreload_env != <span class="hljs-literal">nullptr</span>) &#123;<br>      INFO(<span class="hljs-string">&quot;[ LD_PRELOAD set to \&quot;%s\&quot; ]&quot;</span>, ldpreload_env);<br>    &#125;<br>  &#125;<br><br>  ...省略<br><br>  <span class="hljs-comment">// Use LD_LIBRARY_PATH and LD_PRELOAD (but only if we aren&#x27;t setuid/setgid).</span><br>  parse_LD_LIBRARY_PATH(ldpath_env);<br>  <span class="hljs-comment">// 解析环境变量</span><br>  parse_LD_PRELOAD(ldpreload_env);<br><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">android_namespace_t</span>*&gt; namespaces = init_default_namespaces(exe_info.path.c_str());<br><br>  <span class="hljs-keyword">if</span> (!si-&gt;prelink_image()) __linker_cannot_link(g_argv[<span class="hljs-number">0</span>]);<br><br>  <span class="hljs-comment">// add somain to global group</span><br>  si-&gt;set_dt_flags_1(si-&gt;get_dt_flags_1() | DF_1_GLOBAL);<br>  <span class="hljs-comment">// ... and add it to all other linked namespaces</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> linked_ns : namespaces) &#123;<br>    <span class="hljs-keyword">if</span> (linked_ns != &amp;g_default_namespace) &#123;<br>      linked_ns-&gt;add_soinfo(somain);<br>      somain-&gt;add_secondary_namespace(linked_ns);<br>    &#125;<br>  &#125;<br><br>  linker_setup_exe_static_tls(g_argv[<span class="hljs-number">0</span>]);<br><br>  <span class="hljs-comment">// Load ld_preloads and dependencies.</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*&gt; needed_library_name_list;<br>  <span class="hljs-keyword">size_t</span> ld_preloads_count = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// 将预加载模块作为库的依赖最先添加到加载任务队列</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; ld_preload_name : g_ld_preload_names) &#123;<br>    needed_library_name_list.push_back(ld_preload_name.c_str());<br>    ++ld_preloads_count;<br>  &#125;<br>  <br>  <span class="hljs-comment">// 其次才添加可执行文件的依赖项</span><br>  for_each_dt_needed(si, [&amp;](<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name) &#123;<br>    needed_library_name_list.push_back(name);<br>  &#125;);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>** needed_library_names = &amp;needed_library_name_list[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">size_t</span> needed_libraries_count = needed_library_name_list.size();<br>  <br>  <span class="hljs-comment">// 调用find_libraries加载库</span><br>  <span class="hljs-keyword">if</span> (needed_libraries_count &gt; <span class="hljs-number">0</span> &amp;&amp;<br>      !find_libraries(&amp;g_default_namespace,<br>                      si,<br>                      needed_library_names,<br>                      needed_libraries_count,<br>                      <span class="hljs-literal">nullptr</span>,<br>                      &amp;g_ld_preloads,<br>                      ld_preloads_count,<br>                      RTLD_GLOBAL,<br>                      <span class="hljs-literal">nullptr</span>,<br>                      <span class="hljs-literal">true</span> <span class="hljs-comment">/* add_as_children */</span>,<br>                      &amp;namespaces)) &#123;<br>    __linker_cannot_link(g_argv[<span class="hljs-number">0</span>]);<br>  &#125; <br>  ...省略<br>&#125;<br></code></pre></td></tr></table></figure>
<p>上面分析<code>LD_PRELOAD</code>库最先添加到加载队列，然后调用<code>find_libraries</code>执行加载，此时<code>needed_library_names</code>最前面的元素就是预加载库，继续查看源码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    ns                                加载的命名空间=调用者的命名空间</span><br><span class="hljs-comment">    start_with                        调用者的soinfo</span><br><span class="hljs-comment">    library_names                     所有加载库名称</span><br><span class="hljs-comment">    library_names_count               加载库数量</span><br><span class="hljs-comment">    soinfos                           保存加载完成的soinfo</span><br><span class="hljs-comment">    ld_preloads                       保存预加载库,没有可以为null</span><br><span class="hljs-comment">    ld_preloads_count                 预加载库数量</span><br><span class="hljs-comment">    extinfo                           Android调用附带</span><br><span class="hljs-comment">    add_as_children                   是否作为start_with的子库</span><br><span class="hljs-comment">    search_linked_namespaces          查询链接命名空间</span><br><span class="hljs-comment">    namespaces                        链接命名空间</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">find_libraries</span><span class="hljs-params">(<span class="hljs-keyword">android_namespace_t</span>* ns,</span></span><br><span class="hljs-function"><span class="hljs-params">                    soinfo* start_with,</span></span><br><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-keyword">const</span> library_names[],</span></span><br><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-keyword">size_t</span> library_names_count,</span></span><br><span class="hljs-function"><span class="hljs-params">                    soinfo* soinfos[],</span></span><br><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;soinfo*&gt;* ld_preloads,</span></span><br><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-keyword">size_t</span> ld_preloads_count,</span></span><br><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-keyword">int</span> rtld_flags,</span></span><br><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-keyword">const</span> android_dlextinfo* extinfo,</span></span><br><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-keyword">bool</span> add_as_children,</span></span><br><span class="hljs-function"><span class="hljs-params">                    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">android_namespace_t</span>*&gt;* namespaces)</span> </span>&#123;<br>  <span class="hljs-comment">// Step 0: prepare.</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_map</span>&lt;<span class="hljs-keyword">const</span> soinfo*, ElfReader&gt; readers_map;<br>  LoadTaskList load_tasks;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; library_names_count; ++i) &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name = library_names[i];<br>    load_tasks.push_back(LoadTask::create(name, start_with, ns, &amp;readers_map));<br>  &#125;<br><br>  <span class="hljs-comment">// If soinfos array is null allocate one on stack.</span><br>  <span class="hljs-comment">// The array is needed in case of failure; for example</span><br>  <span class="hljs-comment">// when library_names[] = &#123;libone.so, libtwo.so&#125; and libone.so</span><br>  <span class="hljs-comment">// is loaded correctly but libtwo.so failed for some reason.</span><br>  <span class="hljs-comment">// In this case libone.so should be unloaded on return.</span><br>  <span class="hljs-comment">// See also implementation of failure_guard below.</span><br><br>  <span class="hljs-keyword">if</span> (soinfos == <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">size_t</span> soinfos_size = <span class="hljs-keyword">sizeof</span>(soinfo*)*library_names_count;<br>    soinfos = <span class="hljs-keyword">reinterpret_cast</span>&lt;soinfo**&gt;(alloca(soinfos_size));<br>    <span class="hljs-built_in">memset</span>(soinfos, <span class="hljs-number">0</span>, soinfos_size);<br>  &#125;<br><br>  <span class="hljs-comment">// list of libraries to link - see step 2.</span><br>  <span class="hljs-keyword">size_t</span> soinfos_count = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">auto</span> scope_guard = android::base::make_scope_guard([&amp;]() &#123;<br>    <span class="hljs-keyword">for</span> (LoadTask* t : load_tasks) &#123;<br>      LoadTask::deleter(t);<br>    &#125;<br>  &#125;);<br><br>  ZipArchiveCache zip_archive_cache;<br><br>  <span class="hljs-comment">// Step 1: expand the list of load_tasks to include</span><br>  <span class="hljs-comment">// all DT_NEEDED libraries (do not load them just yet)</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i&lt;load_tasks.size(); ++i) &#123;<br>    LoadTask* task = load_tasks[i];<br>    soinfo* needed_by = task-&gt;get_needed_by();<br><br>    <span class="hljs-keyword">bool</span> is_dt_needed = needed_by != <span class="hljs-literal">nullptr</span> &amp;&amp; (needed_by != start_with || add_as_children);<br>    task-&gt;set_extinfo(is_dt_needed ? <span class="hljs-literal">nullptr</span> : extinfo);<br>    task-&gt;set_dt_needed(is_dt_needed);<br><br>    LD_LOG(kLogDlopen, <span class="hljs-string">&quot;find_libraries(ns=%s): task=%s, is_dt_needed=%d&quot;</span>, ns-&gt;get_name(),<br>           task-&gt;get_name(), is_dt_needed);<br><br>    <span class="hljs-comment">// Note: start from the namespace that is stored in the LoadTask. This namespace</span><br>    <span class="hljs-comment">// is different from the current namespace when the LoadTask is for a transitive</span><br>    <span class="hljs-comment">// dependency and the lib that created the LoadTask is not found in the</span><br>    <span class="hljs-comment">// current namespace but in one of the linked namespace.</span><br>    <span class="hljs-keyword">if</span> (!find_library_internal(<span class="hljs-keyword">const_cast</span>&lt;<span class="hljs-keyword">android_namespace_t</span>*&gt;(task-&gt;get_start_from()),<br>                               task,<br>                               &amp;zip_archive_cache,<br>                               &amp;load_tasks,<br>                               rtld_flags)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    soinfo* si = task-&gt;get_soinfo();<br><br>    <span class="hljs-keyword">if</span> (is_dt_needed) &#123;<br>      needed_by-&gt;add_child(si);<br>    &#125;<br><br>    <span class="hljs-comment">// When ld_preloads is not null, the first</span><br>    <span class="hljs-comment">// ld_preloads_count libs are in fact ld_preloads.</span><br>    <span class="hljs-comment">// 如果预加载库不为空则保存到ld_preloads中</span><br>    <span class="hljs-keyword">if</span> (ld_preloads != <span class="hljs-literal">nullptr</span> &amp;&amp; soinfos_count &lt; ld_preloads_count) &#123;<br>      ld_preloads-&gt;push_back(si);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (soinfos_count &lt; library_names_count) &#123;<br>      soinfos[soinfos_count++] = si;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 第一步已经完成so的加载，并都存在对应的soinfo</span><br><br>  <span class="hljs-comment">// Step 2: Load libraries in random order (see b/24047022)</span><br>  LoadTaskList load_list;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>    soinfo* si = task-&gt;get_soinfo();<br>    <span class="hljs-keyword">auto</span> pred = [&amp;](<span class="hljs-keyword">const</span> LoadTask* t) &#123;<br>      <span class="hljs-keyword">return</span> t-&gt;get_soinfo() == si;<br>    &#125;;<br><br>    <span class="hljs-comment">// 库还未链接则添加到加载列表</span><br>    <span class="hljs-keyword">if</span> (!si-&gt;is_linked() &amp;&amp;<br>        <span class="hljs-built_in">std</span>::find_if(load_list.begin(), load_list.end(), pred) == load_list.end() ) &#123;<br>      load_list.push_back(task);<br>    &#125;<br>  &#125;<br>  ...省略<br><br>  <span class="hljs-comment">// Step 3: pre-link all DT_NEEDED libraries in breadth first order.</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>    soinfo* si = task-&gt;get_soinfo();<br>    <span class="hljs-comment">// 第三步预链接解析所有Dynamic Section</span><br>    <span class="hljs-keyword">if</span> (!si-&gt;is_linked() &amp;&amp; !si-&gt;prelink_image()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    register_soinfo_tls(si);<br>  &#125;<br><br>  <span class="hljs-comment">// Step 4: Construct the global group. Note: DF_1_GLOBAL bit of a library is</span><br>  <span class="hljs-comment">// determined at step 3.</span><br><br>  <span class="hljs-comment">// Step 4-1: DF_1_GLOBAL bit is force set for LD_PRELOADed libs because they</span><br>  <span class="hljs-comment">// must be added to the global group</span><br>  <span class="hljs-comment">// 第四步构造全局组，这里使用了上面的预加载库，设置全局标志</span><br>  <span class="hljs-keyword">if</span> (ld_preloads != <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; si : *ld_preloads) &#123;<br>      si-&gt;set_dt_flags_1(si-&gt;get_dt_flags_1() | DF_1_GLOBAL);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Step 4-2: Gather all DF_1_GLOBAL libs which were newly loaded during this</span><br>  <span class="hljs-comment">// run. These will be the new member of the global group</span><br>  <span class="hljs-keyword">soinfo_list_t</span> new_global_group_members;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>    soinfo* si = task-&gt;get_soinfo();<br>    <span class="hljs-keyword">if</span> (!si-&gt;is_linked() &amp;&amp; (si-&gt;get_dt_flags_1() &amp; DF_1_GLOBAL) != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// 本次加载的全局库作为新的全局组</span><br>      new_global_group_members.push_back(si);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Step 4-3: Add the new global group members to all the linked namespaces</span><br>  <span class="hljs-keyword">if</span> (namespaces != <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> linked_ns : *namespaces) &#123;<br>        <span class="hljs-comment">// 将新的全局组添加到所有链接命名空间</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> si : new_global_group_members) &#123;<br>        <span class="hljs-keyword">if</span> (si-&gt;get_primary_namespace() != linked_ns) &#123;<br>          linked_ns-&gt;add_soinfo(si);<br>          si-&gt;add_secondary_namespace(linked_ns);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Step 5: Collect roots of local_groups.</span><br>  <span class="hljs-comment">// Whenever needed_by-&gt;si link crosses a namespace boundary it forms its own local_group.</span><br>  <span class="hljs-comment">// Here we collect new roots to link them separately later on. Note that we need to avoid</span><br>  <span class="hljs-comment">// collecting duplicates. Also the order is important. They need to be linked in the same</span><br>  <span class="hljs-comment">// BFS order we link individual libraries.</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;soinfo*&gt; local_group_roots;<br>  <span class="hljs-keyword">if</span> (start_with != <span class="hljs-literal">nullptr</span> &amp;&amp; add_as_children) &#123;<br>    local_group_roots.push_back(start_with);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    CHECK(soinfos_count == <span class="hljs-number">1</span>);<br>    local_group_roots.push_back(soinfos[<span class="hljs-number">0</span>]);<br>  &#125;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; task : load_tasks) &#123;<br>    soinfo* si = task-&gt;get_soinfo();<br>    soinfo* needed_by = task-&gt;get_needed_by();<br>    <span class="hljs-keyword">bool</span> is_dt_needed = needed_by != <span class="hljs-literal">nullptr</span> &amp;&amp; (needed_by != start_with || add_as_children);<br>    <span class="hljs-keyword">android_namespace_t</span>* needed_by_ns =<br>        is_dt_needed ? needed_by-&gt;get_primary_namespace() : ns;<br><br>    <span class="hljs-keyword">if</span> (!si-&gt;is_linked() &amp;&amp; si-&gt;get_primary_namespace() != needed_by_ns) &#123;<br>      <span class="hljs-keyword">auto</span> it = <span class="hljs-built_in">std</span>::find(local_group_roots.begin(), local_group_roots.end(), si);<br>      LD_LOG(kLogDlopen,<br>             <span class="hljs-string">&quot;Crossing namespace boundary (si=%s@%p, si_ns=%s@%p, needed_by=%s@%p, ns=%s@%p, needed_by_ns=%s@%p) adding to local_group_roots: %s&quot;</span>,<br>             si-&gt;get_realpath(),<br>             si,<br>             si-&gt;get_primary_namespace()-&gt;get_name(),<br>             si-&gt;get_primary_namespace(),<br>             needed_by == <span class="hljs-literal">nullptr</span> ? <span class="hljs-string">&quot;(nullptr)&quot;</span> : needed_by-&gt;get_realpath(),<br>             needed_by,<br>             ns-&gt;get_name(),<br>             ns,<br>             needed_by_ns-&gt;get_name(),<br>             needed_by_ns,<br>             it == local_group_roots.end() ? <span class="hljs-string">&quot;yes&quot;</span> : <span class="hljs-string">&quot;no&quot;</span>);<br><br>      <span class="hljs-keyword">if</span> (it == local_group_roots.end()) &#123;<br>        local_group_roots.push_back(si);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Step 6: Link all local groups</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> root : local_group_roots) &#123;<br>    <span class="hljs-keyword">soinfo_list_t</span> local_group;<br>    <span class="hljs-keyword">android_namespace_t</span>* local_group_ns = root-&gt;get_primary_namespace();<br><br>    walk_dependencies_tree(root,<br>      [&amp;] (soinfo* si) &#123;<br>        <span class="hljs-keyword">if</span> (local_group_ns-&gt;is_accessible(si)) &#123;<br>          local_group.push_back(si);<br>          <span class="hljs-keyword">return</span> kWalkContinue;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> kWalkSkip;<br>        &#125;<br>      &#125;);<br><br>    <span class="hljs-comment">// 获取全局组包含的soinfo，因为预加载库是一起加载的跟local_group_ns是同一个命名空间</span><br>    <span class="hljs-comment">// 所有这里的全局组已经包含了预加载库</span><br>    <span class="hljs-keyword">soinfo_list_t</span> global_group = local_group_ns-&gt;get_global_group();<br>    <span class="hljs-function">SymbolLookupList <span class="hljs-title">lookup_list</span><span class="hljs-params">(global_group, local_group)</span></span>;<br>    soinfo* local_group_root = local_group.front();<br><br>    <span class="hljs-keyword">bool</span> linked = local_group.visit([&amp;](soinfo* si) &#123;<br>      <span class="hljs-comment">// Even though local group may contain accessible soinfos from other namespaces</span><br>      <span class="hljs-comment">// we should avoid linking them (because if they are not linked -&gt; they</span><br>      <span class="hljs-comment">// are in the local_group_roots and will be linked later).</span><br>      <span class="hljs-keyword">if</span> (!si-&gt;is_linked() &amp;&amp; si-&gt;get_primary_namespace() == local_group_ns) &#123;<br>        <span class="hljs-keyword">const</span> android_dlextinfo* link_extinfo = <span class="hljs-literal">nullptr</span>;<br>        <span class="hljs-keyword">if</span> (si == soinfos[<span class="hljs-number">0</span>] || reserved_address_recursive) &#123;<br>          <span class="hljs-comment">// Only forward extinfo for the first library unless the recursive</span><br>          <span class="hljs-comment">// flag is set.</span><br>          link_extinfo = extinfo;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (__libc_shared_globals()-&gt;load_hook) &#123;<br>          __libc_shared_globals()-&gt;load_hook(si-&gt;load_bias, si-&gt;phdr, si-&gt;phnum);<br>        &#125;<br>        lookup_list.set_dt_symbolic_lib(si-&gt;has_DT_SYMBOLIC ? si : <span class="hljs-literal">nullptr</span>);<br>        <span class="hljs-comment">// 链接库使用上面的lookup_list</span><br>        <span class="hljs-keyword">if</span> (!si-&gt;link_image(lookup_list, local_group_root, link_extinfo, &amp;relro_fd_offset) ||<br>            !get_cfi_shadow()-&gt;AfterLoad(si, solist_get_head())) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125;<br><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;);<br><br>    <span class="hljs-keyword">if</span> (!linked) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br>  ...省略<br><br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>经上面代码注释了解到预加载库作为首先加载的库，且库调用<code>si-&gt;set_dt_flags_1(si-&gt;get_dt_flags_1() | DF_1_GLOBAL);</code>设置了<code>DF_1_GLOBAL</code>标志，后续再将全局库添加到它所有的链接命名空间内</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++">  <span class="hljs-keyword">if</span> (namespaces != <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> linked_ns : *namespaces) &#123;<br>        <span class="hljs-comment">// 将新的全局组添加到所有链接命名空间</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> si : new_global_group_members) &#123;<br>        <span class="hljs-keyword">if</span> (si-&gt;get_primary_namespace() != linked_ns) &#123;<br>          linked_ns-&gt;add_soinfo(si);<br>          si-&gt;add_secondary_namespace(linked_ns);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 获取全局库就是根据 DF_1_GLOBAL 来获取</span><br>  <span class="hljs-function"><span class="hljs-keyword">soinfo_list_t</span> <span class="hljs-title">android_namespace_t::get_global_group</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">soinfo_list_t</span> global_group;<br>  soinfo_list().for_each([&amp;](soinfo* si) &#123;<br>    <span class="hljs-keyword">if</span> ((si-&gt;get_dt_flags_1() &amp; DF_1_GLOBAL) != <span class="hljs-number">0</span>) &#123;<br>      global_group.push_back(si);<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> global_group;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>我们后面添加全局库就按照这个步骤来，后续查找符号时全局库集合调用<code>local_group_ns-&gt;get_global_group();</code>，因为我们本身加载的全局库跟待加载的库都在一个命名空间所以这里包含了我们的全局库，接下来开始链接库<code>si-&gt;link_image(lookup_list, local_group_root, link_extinfo, &amp;relro_fd_offset) ||!get_cfi_shadow()-&gt;AfterLoad(si, solist_get_head())</code> 其中<code>lookup_list</code>包含了全局组和本地组，其中<code>link_image</code>中调用了<code>relocate(lookup_list)</code>来重定向库的导入符号</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">soinfo::link_image</span><span class="hljs-params">(<span class="hljs-keyword">const</span> SymbolLookupList&amp; lookup_list, soinfo* local_group_root,</span></span><br><span class="hljs-function"><span class="hljs-params">                        <span class="hljs-keyword">const</span> android_dlextinfo* extinfo, <span class="hljs-keyword">size_t</span>* relro_fd_offset)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (is_image_linked()) &#123;<br>    <span class="hljs-comment">// already linked.</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (g_is_ldd &amp;&amp; !is_main_executable()) &#123;<br>    async_safe_format_fd(STDOUT_FILENO, <span class="hljs-string">&quot;\t%s =&gt; %s (%p)\n&quot;</span>, get_soname(),<br>                         get_realpath(), <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>*&gt;(base));<br>  &#125;<br><br>  local_group_root_ = local_group_root;<br>  <span class="hljs-keyword">if</span> (local_group_root_ == <span class="hljs-literal">nullptr</span>) &#123;<br>    local_group_root_ = <span class="hljs-keyword">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> ((flags_ &amp; FLAG_LINKER) == <span class="hljs-number">0</span> &amp;&amp; local_group_root_ == <span class="hljs-keyword">this</span>) &#123;<br>    target_sdk_version_ = get_application_target_sdk_version();<br>  &#125;<br><br>  ...省略<br><br>  <span class="hljs-keyword">if</span> (!relocate(lookup_list)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  ...省略<br>&#125;<br></code></pre></td></tr></table></figure>
<p>符号重定向源码分析</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">soinfo::relocate</span><span class="hljs-params">(<span class="hljs-keyword">const</span> SymbolLookupList&amp; lookup_list)</span> </span>&#123;<br><br>  VersionTracker version_tracker;<br><br>  <span class="hljs-keyword">if</span> (!version_tracker.init(<span class="hljs-keyword">this</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-function">Relocator <span class="hljs-title">relocator</span><span class="hljs-params">(version_tracker, lookup_list)</span></span>;<br>  relocator.si = <span class="hljs-keyword">this</span>;<br>  relocator.si_strtab = strtab_;<br>  relocator.si_strtab_size = has_min_version(<span class="hljs-number">1</span>) ? strtab_size_ : SIZE_MAX;<br>  relocator.si_symtab = symtab_;<br>  relocator.tlsdesc_args = &amp;tlsdesc_args_;<br>  relocator.tls_tp_base = __libc_shared_globals()-&gt;static_tls_layout.offset_thread_pointer();<br><br>  <span class="hljs-keyword">if</span> (android_relocs_ != <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-comment">// check signature</span><br>    <span class="hljs-keyword">if</span> (android_relocs_size_ &gt; <span class="hljs-number">3</span> &amp;&amp;<br>        android_relocs_[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;A&#x27;</span> &amp;&amp;<br>        android_relocs_[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;P&#x27;</span> &amp;&amp;<br>        android_relocs_[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;S&#x27;</span> &amp;&amp;<br>        android_relocs_[<span class="hljs-number">3</span>] == <span class="hljs-string">&#x27;2&#x27;</span>) &#123;<br>      DEBUG(<span class="hljs-string">&quot;[ android relocating %s ]&quot;</span>, get_realpath());<br><br>      <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span>* packed_relocs = android_relocs_ + <span class="hljs-number">4</span>;<br>      <span class="hljs-keyword">const</span> <span class="hljs-keyword">size_t</span> packed_relocs_size = android_relocs_size_ - <span class="hljs-number">4</span>;<br><br>      <span class="hljs-keyword">if</span> (!packed_relocate&lt;RelocMode::Typical&gt;(relocator, sleb128_decoder(packed_relocs, packed_relocs_size))) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      DL_ERR(<span class="hljs-string">&quot;bad android relocation header.&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (relr_ != <span class="hljs-literal">nullptr</span>) &#123;<br>    DEBUG(<span class="hljs-string">&quot;[ relocating %s relr ]&quot;</span>, get_realpath());<br>    <span class="hljs-keyword">if</span> (!relocate_relr()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br><span class="hljs-comment">// rela重定向</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(USE_RELA)</span><br>  <span class="hljs-keyword">if</span> (rela_ != <span class="hljs-literal">nullptr</span>) &#123;<br>    DEBUG(<span class="hljs-string">&quot;[ relocating %s rela ]&quot;</span>, get_realpath());<br><br>    <span class="hljs-keyword">if</span> (!plain_relocate&lt;RelocMode::Typical&gt;(relocator, rela_, rela_count_)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (plt_rela_ != <span class="hljs-literal">nullptr</span>) &#123;<br>    DEBUG(<span class="hljs-string">&quot;[ relocating %s plt rela ]&quot;</span>, get_realpath());<br>    <span class="hljs-keyword">if</span> (!plain_relocate&lt;RelocMode::JumpTable&gt;(relocator, plt_rela_, plt_rela_count_)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br><span class="hljs-comment">// rel重定向</span><br>  <span class="hljs-keyword">if</span> (rel_ != <span class="hljs-literal">nullptr</span>) &#123;<br>    DEBUG(<span class="hljs-string">&quot;[ relocating %s rel ]&quot;</span>, get_realpath());<br>    <span class="hljs-keyword">if</span> (!plain_relocate&lt;RelocMode::Typical&gt;(relocator, rel_, rel_count_)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (plt_rel_ != <span class="hljs-literal">nullptr</span>) &#123;<br>    DEBUG(<span class="hljs-string">&quot;[ relocating %s plt rel ]&quot;</span>, get_realpath());<br>    <span class="hljs-keyword">if</span> (!plain_relocate&lt;RelocMode::JumpTable&gt;(relocator, plt_rel_, plt_rel_count_)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br>  <span class="hljs-comment">// Once the tlsdesc_args_ vector&#x27;s size is finalized, we can write the addresses of its elements</span><br>  <span class="hljs-comment">// into the TLSDESC relocations.</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__aarch64__)</span><br>  <span class="hljs-comment">// Bionic currently only implements TLSDESC for arm64.</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">pair</span>&lt;TlsDescriptor*, <span class="hljs-keyword">size_t</span>&gt;&amp; <span class="hljs-built_in">pair</span> : relocator.deferred_tlsdesc_relocs) &#123;<br>    TlsDescriptor* desc = <span class="hljs-built_in">pair</span>.first;<br>    desc-&gt;func = tlsdesc_resolver_dynamic;<br>    desc-&gt;arg = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">size_t</span>&gt;(&amp;tlsdesc_args_[<span class="hljs-built_in">pair</span>.second]);<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>最终调用 <code>plain_relocate()</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;RelocMode OptMode, <span class="hljs-keyword">typename</span> ...Args&gt;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">plain_relocate</span><span class="hljs-params">(Relocator&amp; relocator, Args ...args)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> needs_slow_relocate_loop(relocator) ?<br>      plain_relocate_impl&lt;RelocMode::General&gt;(relocator, args...) :<br>      plain_relocate_impl&lt;OptMode&gt;(relocator, args...);<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;RelocMode Mode&gt;<br>__attribute__((noinline))<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">plain_relocate_impl</span><span class="hljs-params">(Relocator&amp; relocator, <span class="hljs-keyword">rel_t</span>* rels, <span class="hljs-keyword">size_t</span> rel_count)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; rel_count; ++i) &#123;<br>    <span class="hljs-keyword">if</span> (!process_relocation&lt;Mode&gt;(relocator, rels[i])) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;RelocMode Mode&gt;<br>__attribute__((always_inline))<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">process_relocation</span><span class="hljs-params">(Relocator&amp; relocator, <span class="hljs-keyword">const</span> <span class="hljs-keyword">rel_t</span>&amp; reloc)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> Mode == RelocMode::General ?<br>      process_relocation_general(relocator, reloc) :<br>      process_relocation_impl&lt;Mode&gt;(relocator, reloc);<br>&#125;<br><br>__attribute__((noinline))<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">process_relocation_general</span><span class="hljs-params">(Relocator&amp; relocator, <span class="hljs-keyword">const</span> <span class="hljs-keyword">rel_t</span>&amp; reloc)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> process_relocation_impl&lt;RelocMode::General&gt;(relocator, reloc);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>最终实现符号重定向是在<code>process_relocation_impl</code>方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;RelocMode Mode&gt;<br>__attribute__((always_inline))<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">process_relocation_impl</span><span class="hljs-params">(Relocator&amp; relocator, <span class="hljs-keyword">const</span> <span class="hljs-keyword">rel_t</span>&amp; reloc)</span> </span>&#123;<br>  <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">bool</span> IsGeneral = Mode == RelocMode::General;<br><br>  <span class="hljs-keyword">void</span>* <span class="hljs-keyword">const</span> rel_target = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>*&gt;(reloc.r_offset + relocator.si-&gt;load_bias);<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> r_type = ELFW(R_TYPE)(reloc.r_info);<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> r_sym = ELFW(R_SYM)(reloc.r_info);<br><br>  soinfo* found_in = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Sym)</span>* sym </span>= <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* sym_name = <span class="hljs-literal">nullptr</span>;<br>  ElfW(Addr) sym_addr = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">if</span> (r_sym != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 获取重定向的符号名</span><br>    sym_name = relocator.get_string(relocator.si_symtab[r_sym].st_name);<br>  &#125;<br><br> ...省略<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(USE_RELA)</span><br>  <span class="hljs-keyword">auto</span> get_addend_rel   = [&amp;]() -&gt; ElfW(Addr) &#123; <span class="hljs-keyword">return</span> reloc.r_addend; &#125;;<br>  <span class="hljs-keyword">auto</span> get_addend_norel = [&amp;]() -&gt; ElfW(Addr) &#123; <span class="hljs-keyword">return</span> reloc.r_addend; &#125;;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>  <span class="hljs-keyword">auto</span> get_addend_rel   = [&amp;]() -&gt; ElfW(Addr) &#123; <span class="hljs-keyword">return</span> *<span class="hljs-keyword">static_cast</span>&lt;ElfW(Addr)*&gt;(rel_target); &#125;;<br>  <span class="hljs-keyword">auto</span> get_addend_norel = [&amp;]() -&gt; ElfW(Addr) &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; &#125;;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    <span class="hljs-comment">// 通常符号都不是STT_TLS类型</span><br>  <span class="hljs-keyword">if</span> (IsGeneral &amp;&amp; is_tls_reloc(r_type)) &#123;<br>    ... 省略<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (r_sym == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// Do nothing.</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 这里具体查找符号</span><br>      <span class="hljs-keyword">if</span> (!lookup_symbol&lt;IsGeneral&gt;(relocator, r_sym, sym_name, &amp;found_in, &amp;sym)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">if</span> (sym != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span> should_protect_segments = handle_text_relocs &amp;&amp;<br>                                             found_in == relocator.si &amp;&amp;<br>                                             ELF_ST_TYPE(sym-&gt;st_info) == STT_GNU_IFUNC;<br>        <span class="hljs-keyword">if</span> (should_protect_segments &amp;&amp; !protect_segments()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">// 计算符号地址ElfW(Sym) 加上模块基址</span><br>        sym_addr = found_in-&gt;resolve_symbol_address(sym);<br>        <span class="hljs-keyword">if</span> (should_protect_segments &amp;&amp; !unprotect_segments()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">constexpr</span> (IsGeneral) &#123;<br>        <span class="hljs-comment">// A weak reference to an undefined symbol. We typically use a zero symbol address, but</span><br>        <span class="hljs-comment">// use the relocation base for PC-relative relocations, so that the value written is zero.</span><br>        <span class="hljs-keyword">switch</span> (r_type) &#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__x86_64__)</span><br>          <span class="hljs-keyword">case</span> R_X86_64_PC32:<br>            sym_addr = <span class="hljs-keyword">reinterpret_cast</span>&lt;ElfW(Addr)&gt;(rel_target);<br>            <span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined(__i386__)</span><br>          <span class="hljs-keyword">case</span> R_386_PC32:<br>            sym_addr = <span class="hljs-keyword">reinterpret_cast</span>&lt;ElfW(Addr)&gt;(rel_target);<br>            <span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 大部分符号类型都是 R_GENERIC_JUMP_SLOT </span><br>  <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(IsGeneral || Mode == RelocMode::JumpTable)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (r_type == R_GENERIC_JUMP_SLOT) &#123;<br>      count_relocation_if&lt;IsGeneral&gt;(kRelocAbsolute);<br>      <span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Addr)</span> result </span>= sym_addr + get_addend_norel();<br>      trace_reloc(<span class="hljs-string">&quot;RELO JMP_SLOT %16p &lt;- %16p %s&quot;</span>,<br>                  rel_target, <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>*&gt;(result), sym_name);<br>        <span class="hljs-comment">// 赋值</span><br>      *<span class="hljs-keyword">static_cast</span>&lt;ElfW(Addr)*&gt;(rel_target) = result;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br>  ...省略其它类型符号地址计算及赋值<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其中最关键的符号查找调用<code>lookup_symbol</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">bool</span> DoLogging&gt;<br>__attribute__((always_inline))<br><span class="hljs-comment">// relocator 就是前面传进来包含全局组和本地组的soinfos，全局组排在最前面</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">lookup_symbol</span><span class="hljs-params">(Relocator&amp; relocator, <span class="hljs-keyword">uint32_t</span> r_sym, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* sym_name,</span></span><br><span class="hljs-function"><span class="hljs-params">                                 soinfo** found_in, <span class="hljs-keyword">const</span> ElfW(Sym)** sym)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (r_sym == relocator.cache_sym_val) &#123;<br>    <span class="hljs-comment">// 如果是上次查询到的符号则没有必要再次查询</span><br>    *found_in = relocator.cache_si;<br>    *sym = relocator.cache_sym;<br>    count_relocation_if&lt;DoLogging&gt;(kRelocSymbolCached);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 判断版本是否匹配</span><br>    <span class="hljs-keyword">const</span> version_info* vi = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-keyword">if</span> (!relocator.si-&gt;lookup_version_info(relocator.version_tracker, r_sym, sym_name, &amp;vi)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    soinfo* local_found_in = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-comment">// 最终调用soinfo_do_lookup查询符号</span><br>    <span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Sym)</span>* local_sym </span>= soinfo_do_lookup(sym_name, vi, &amp;local_found_in, relocator.lookup_list);<br><br>    relocator.cache_sym_val = r_sym;<br>    relocator.cache_si = local_found_in;<br>    relocator.cache_sym = local_sym;<br>    *found_in = local_found_in;<br>    *sym = local_sym;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (*sym == <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">if</span> (ELF_ST_BIND(relocator.si_symtab[r_sym].st_info) != STB_WEAK) &#123;<br>      DL_ERR(<span class="hljs-string">&quot;cannot locate symbol \&quot;%s\&quot; referenced by \&quot;%s\&quot;...&quot;</span>, sym_name, relocator.si-&gt;get_realpath());<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br><br>  count_relocation_if&lt;DoLogging&gt;(kRelocSymbol);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Sym)</span>* <span class="hljs-title">soinfo_do_lookup</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name, <span class="hljs-keyword">const</span> version_info* vi,</span></span><br><span class="hljs-function"><span class="hljs-params">                                  soinfo** si_found_in, <span class="hljs-keyword">const</span> SymbolLookupList&amp; lookup_list)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> lookup_list.needs_slow_path() ?<br>      soinfo_do_lookup_impl&lt;<span class="hljs-literal">true</span>&gt;(name, vi, si_found_in, lookup_list) :<br>      soinfo_do_lookup_impl&lt;<span class="hljs-literal">false</span>&gt;(name, vi, si_found_in, lookup_list);<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">bool</span> IsGeneral&gt;<br>__attribute__((noinline)) <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Sym)</span>*</span><br><span class="hljs-function"><span class="hljs-comment">// 最终查找符号的实现函数</span></span><br><span class="hljs-function"><span class="hljs-title">soinfo_do_lookup_impl</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name, <span class="hljs-keyword">const</span> version_info* vi,</span></span><br><span class="hljs-function"><span class="hljs-params">                      soinfo** si_found_in, <span class="hljs-keyword">const</span> SymbolLookupList&amp; lookup_list)</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> [ hash, name_len ] = calculate_gnu_hash(name);<br>  <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">uint32_t</span> kBloomMaskBits = <span class="hljs-keyword">sizeof</span>(ElfW(Addr)) * <span class="hljs-number">8</span>;<br>  <span class="hljs-function">SymbolName <span class="hljs-title">elf_symbol_name</span><span class="hljs-params">(name)</span></span>;<br>  <span class="hljs-comment">// 这里的lookup_list正是调用 link_image传入的SymbolLookupLib，全局库在最前面</span><br>  <span class="hljs-keyword">const</span> SymbolLookupLib* end = lookup_list.end();<br>  <span class="hljs-keyword">const</span> SymbolLookupLib* it = lookup_list.begin();<br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-keyword">const</span> SymbolLookupLib* lib;<br>    <span class="hljs-keyword">uint32_t</span> sym_idx;<br><br>    <span class="hljs-comment">// Iterate over libraries until we find one whose Bloom filter matches the symbol we&#x27;re</span><br>    <span class="hljs-comment">// searching for.</span><br>    <span class="hljs-comment">// 每个库挨个查找有没有指定符号</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>      <span class="hljs-keyword">if</span> (it == end) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>      lib = it++;<br><br>      <span class="hljs-keyword">if</span> (IsGeneral &amp;&amp; lib-&gt;needs_sysv_lookup()) &#123;<br>        <span class="hljs-comment">// 没有hash表则直接查找符号名</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">const</span> ElfW(Sym)* sym = lib-&gt;si_-&gt;find_symbol_by_name(elf_symbol_name, vi)) &#123;<br>          *si_found_in = lib-&gt;si_;<br>          <span class="hljs-keyword">return</span> sym;<br>        &#125;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (IsGeneral) &#123;<br>        TRACE_TYPE(LOOKUP, <span class="hljs-string">&quot;SEARCH %s in %s@%p (gnu)&quot;</span>,<br>                   name, lib-&gt;si_-&gt;get_realpath(), <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>*&gt;(lib-&gt;si_-&gt;base));<br>      &#125;<br>     <span class="hljs-comment">// 计算符号hash桶查询链</span><br>      <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> word_num = (hash / kBloomMaskBits) &amp; lib-&gt;gnu_maskwords_;<br>      <span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Addr)</span> bloom_word </span>= lib-&gt;gnu_bloom_filter_[word_num];<br>      <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> h1 = hash % kBloomMaskBits;<br>      <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> h2 = (hash &gt;&gt; lib-&gt;gnu_shift2_) % kBloomMaskBits;<br><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-number">1</span> &amp; (bloom_word &gt;&gt; h1) &amp; (bloom_word &gt;&gt; h2)) == <span class="hljs-number">1</span>) &#123;<br>        sym_idx = lib-&gt;gnu_bucket_[hash % lib-&gt;gnu_nbucket_];<br>        <span class="hljs-keyword">if</span> (sym_idx != <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (IsGeneral) &#123;<br>        TRACE_TYPE(LOOKUP, <span class="hljs-string">&quot;NOT FOUND %s in %s@%p&quot;</span>,<br>                   name, lib-&gt;si_-&gt;get_realpath(), <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>*&gt;(lib-&gt;si_-&gt;base));<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Search the library&#x27;s hash table chain.</span><br>    ElfW(Versym) verneed = kVersymNotNeeded;<br>    <span class="hljs-keyword">bool</span> calculated_verneed = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">uint32_t</span> chain_value = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Sym)</span>* sym </span>= <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-comment">// 根据符号hash快速查找</span><br>    <span class="hljs-keyword">do</span> &#123;<br>      sym = lib-&gt;symtab_ + sym_idx;<br>      chain_value = lib-&gt;gnu_chain_[sym_idx];<br>      <span class="hljs-keyword">if</span> ((chain_value &gt;&gt; <span class="hljs-number">1</span>) == (hash &gt;&gt; <span class="hljs-number">1</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (vi != <span class="hljs-literal">nullptr</span> &amp;&amp; !calculated_verneed) &#123;<br>          calculated_verneed = <span class="hljs-literal">true</span>;<br>          verneed = find_verdef_version_index(lib-&gt;si_, vi);<br>        &#125;<br>        <span class="hljs-comment">// 查找必须版本匹配且符号被定义为全局</span><br>        <span class="hljs-keyword">if</span> (check_symbol_version(lib-&gt;versym_, sym_idx, verneed) &amp;&amp;<br>            <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">size_t</span>&gt;(sym-&gt;st_name) + name_len + <span class="hljs-number">1</span> &lt;= lib-&gt;strtab_size_ &amp;&amp;<br>            <span class="hljs-built_in">memcmp</span>(lib-&gt;strtab_ + sym-&gt;st_name, name, name_len + <span class="hljs-number">1</span>) == <span class="hljs-number">0</span> &amp;&amp;<br>            is_symbol_global_and_defined(lib-&gt;si_, sym)) &#123;<br>          *si_found_in = lib-&gt;si_;<br>          <span class="hljs-keyword">if</span> (IsGeneral) &#123;<br>            TRACE_TYPE(LOOKUP, <span class="hljs-string">&quot;FOUND %s in %s (%p) %zd&quot;</span>,<br>                       name, lib-&gt;si_-&gt;get_realpath(), <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>*&gt;(sym-&gt;st_value),<br>                       <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">size_t</span>&gt;(sym-&gt;st_size));<br>          &#125;<br>          <span class="hljs-keyword">return</span> sym;<br>        &#125;<br>      &#125;<br>      ++sym_idx;<br>    &#125; <span class="hljs-keyword">while</span> ((chain_value &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">if</span> (IsGeneral) &#123;<br>      TRACE_TYPE(LOOKUP, <span class="hljs-string">&quot;NOT FOUND %s in %s@%p&quot;</span>,<br>                 name, lib-&gt;si_-&gt;get_realpath(), <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">void</span>*&gt;(lib-&gt;si_-&gt;base));<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以发现最终实现符号查找在<code>soinfo_do_lookup_impl</code>查找规则是先查找全局库后查找依赖库，有hash表则查询hash表没用则直接查询符号名称，hash表也分为<code>elf hash</code>（低版本）与<code>gnu hash</code>（高版本）</p>
<p>因此我们已经知道了添加全局库的步骤如下</p>
<ol>
<li>将该全局库<code>soinfo</code>添加<code>DF_1_GLOBAL</code>标志<code>si-&gt;set_dt_flags_1(si-&gt;get_dt_flags_1() | DF_1_GLOBAL)</code></li>
<li>添加该<code>soinfo</code>到所有链接命名空间<code>linked_ns-&gt;add_soinfo(si);si-&gt;add_secondary_namespace(linked_ns);</code></li>
</ol>
<p>分析源码也可知只有在<code>linker</code>初始化执行时才会有全局库的加载，后续使用<code>dlopen</code>并未解析，那么后续创建的命名空间也会包含全局库吗</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">android_namespace_t</span>* <span class="hljs-title">create_namespace</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* caller_addr,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* ld_library_path,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* default_library_path,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      <span class="hljs-keyword">uint64_t</span> type,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* permitted_when_isolated_path,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      <span class="hljs-keyword">android_namespace_t</span>* parent_namespace)</span> </span>&#123;<br>  <span class="hljs-comment">// 创建命名空间肯定会有一个父命名空间                                       </span><br>  <span class="hljs-keyword">if</span> (parent_namespace == <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-comment">// if parent_namespace is nullptr -&gt; set it to the caller namespace</span><br>    soinfo* caller_soinfo = find_containing_library(caller_addr);<br><br>    parent_namespace = caller_soinfo != <span class="hljs-literal">nullptr</span> ?<br>                       caller_soinfo-&gt;get_primary_namespace() :<br>                       g_anonymous_namespace;<br>  &#125;<br><br>  ProtectedDataGuard guard;<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; ld_library_paths;<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; default_library_paths;<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; permitted_paths;<br><br>  parse_path(ld_library_path, <span class="hljs-string">&quot;:&quot;</span>, &amp;ld_library_paths);<br>  parse_path(default_library_path, <span class="hljs-string">&quot;:&quot;</span>, &amp;default_library_paths);<br>  parse_path(permitted_when_isolated_path, <span class="hljs-string">&quot;:&quot;</span>, &amp;permitted_paths);<br><br>  <span class="hljs-keyword">android_namespace_t</span>* ns = <span class="hljs-keyword">new</span> (g_namespace_allocator.alloc()) <span class="hljs-keyword">android_namespace_t</span>();<br>  ns-&gt;set_name(name);<br>  ns-&gt;set_isolated((type &amp; ANDROID_NAMESPACE_TYPE_ISOLATED) != <span class="hljs-number">0</span>);<br>  ns-&gt;set_greylist_enabled((type &amp; ANDROID_NAMESPACE_TYPE_GREYLIST_ENABLED) != <span class="hljs-number">0</span>);<br>  ns-&gt;set_also_used_as_anonymous((type &amp; ANDROID_NAMESPACE_TYPE_ALSO_USED_AS_ANONYMOUS) != <span class="hljs-number">0</span>);<br><br>  <span class="hljs-comment">// Android Java加载库会附带ANDROID_NAMESPACE_TYPE_SHARED标志</span><br>  <span class="hljs-keyword">if</span> ((type &amp; ANDROID_NAMESPACE_TYPE_SHARED) != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// append parent namespace paths.</span><br>    <span class="hljs-comment">// 复制父命名空间的库加载路径，以及允许的路径</span><br>    <span class="hljs-built_in">std</span>::copy(parent_namespace-&gt;get_ld_library_paths().begin(),<br>              parent_namespace-&gt;get_ld_library_paths().end(),<br>              back_inserter(ld_library_paths));<br><br>    <span class="hljs-built_in">std</span>::copy(parent_namespace-&gt;get_default_library_paths().begin(),<br>              parent_namespace-&gt;get_default_library_paths().end(),<br>              back_inserter(default_library_paths));<br><br>    <span class="hljs-built_in">std</span>::copy(parent_namespace-&gt;get_permitted_paths().begin(),<br>              parent_namespace-&gt;get_permitted_paths().end(),<br>              back_inserter(permitted_paths));<br><br>    <span class="hljs-comment">// If shared - clone the parent namespace</span><br>    <span class="hljs-comment">// Java调用完全继承所有soinfo</span><br>    add_soinfos_to_namespace(parent_namespace-&gt;soinfo_list(), ns);<br>    <span class="hljs-comment">// and copy parent namespace links</span><br>    <span class="hljs-comment">// 同时继承链接命名空间</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; link : parent_namespace-&gt;linked_namespaces()) &#123;<br>      ns-&gt;add_linked_namespace(link.linked_namespace(), link.shared_lib_sonames(),<br>                               link.allow_all_shared_libs());<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// If not shared - copy only the shared group</span><br>    <span class="hljs-comment">// 非Java调用只复制共享的库</span><br>    add_soinfos_to_namespace(parent_namespace-&gt;get_shared_group(), ns);<br>  &#125;<br><br>  ns-&gt;set_ld_library_paths(<span class="hljs-built_in">std</span>::move(ld_library_paths));<br>  ns-&gt;set_default_library_paths(<span class="hljs-built_in">std</span>::move(default_library_paths));<br>  ns-&gt;set_permitted_paths(<span class="hljs-built_in">std</span>::move(permitted_paths));<br><br>  <span class="hljs-keyword">if</span> (ns-&gt;is_also_used_as_anonymous() &amp;&amp; !set_anonymous_namespace(ns)) &#123;<br>    DL_ERR(<span class="hljs-string">&quot;failed to set namespace: [name=\&quot;%s\&quot;, ld_library_path=\&quot;%s\&quot;, default_library_paths=\&quot;%s\&quot;&quot;</span><br>           <span class="hljs-string">&quot; permitted_paths=\&quot;%s\&quot;] as the anonymous namespace&quot;</span>,<br>           ns-&gt;get_name(),<br>           android::base::Join(ns-&gt;get_ld_library_paths(), <span class="hljs-string">&#x27;:&#x27;</span>).c_str(),<br>           android::base::Join(ns-&gt;get_default_library_paths(), <span class="hljs-string">&#x27;:&#x27;</span>).c_str(),<br>           android::base::Join(ns-&gt;get_permitted_paths(), <span class="hljs-string">&#x27;:&#x27;</span>).c_str());<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> ns;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">soinfo_list_t</span> <span class="hljs-title">android_namespace_t::get_shared_group</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == &amp;g_default_namespace) &#123;<br>    <span class="hljs-keyword">return</span> get_global_group();<br>  &#125;<br><br>  <span class="hljs-keyword">soinfo_list_t</span> shared_group;<br>  soinfo_list().for_each([&amp;](soinfo* si) &#123;<br>    <span class="hljs-keyword">if</span> ((si-&gt;get_rtld_flags() &amp; RTLD_GLOBAL) != <span class="hljs-number">0</span>) &#123;<br>      shared_group.push_back(si);<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> shared_group;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里JAVA使用命名空间一般有两个，都是跟<code>ClassLoader</code>绑定在一起，包含系统<code>ClassLoader</code>和应用<code>ClassLoader</code>，关于命名空间介绍可以查看我的另一篇文章<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-948942-1-1.html">Android7.0以上命名空间详解(dlopen限制)</a>，<code>get_shared_group</code>查找了命名空间内<code>soinfo</code>的<code>RTLD_GLOBAL</code>库查找，所以只要我们将全局库添加至所有命名空间并设置好标志后续创建的库都会默认包含我们的库。</p>
<p>分析到这里我们的目的已经很明确了：1.设置全局标志。2.将库添加到所有命名空间。当然Android7.0以下没有命名空间则直接省略第二步。</p>
<h2 id="代码实现添加全局库-参考fake-linker源码"><a href="#代码实现添加全局库-参考fake-linker源码" class="headerlink" title="代码实现添加全局库  参考fake-linker源码"></a>代码实现添加全局库  参考<a target="_blank" rel="noopener" href="https://github.com/sanfengAndroid/fake-linker">fake-linker</a>源码</h2><ol>
<li><p>获取所有命名空间</p>
<p> 在<code>linker_main.cpp</code>中有<code>static soinfo* solist;</code>全局静态变量，通过它可以获取到所有已加载的<code>soinfo</code>进而得到所有命名空间，执行时机越早则找到的命名空间越全，可能存在部分Android使用的命名空间无法找到，只需要在Hook模块特殊处理<code>android_dlopen_ext</code>确保添加全局库即可</p>
</li>
<li><p>设置全局库</p>
<p> 参考项目<a target="_blank" rel="noopener" href="https://github.com/sanfengAndroid/fake-linker">fake-linker</a>源码</p>
</li>
<li><p>项目其它的一些处理</p>
<ol>
<li>每个Android版本<code>soinfo</code>几乎都有变动，且不同版本使用STL版本可能还不一样，因此针对每个API等级一个库，目前支持Android 5.0~Android 11</li>
<li>源码涉及到一些<code>linker</code>内部符号查找，通过解析节区符号表来实现，通常来说<code>linker</code>都没有去除内部符号表，但是其它模块几乎都是去除掉的，因此对于某些特别手机<code>linker</code>去除掉内部符号表则无法使用</li>
<li>由于执行时机的问题某些模块（”libjavacore.so”, “libnativehelper.so”, “libnativeloader.so”, “libart.so”, “libopenjdk.so”，我们在Application执行其系统环境已经准备好了）已经链接过了，这时需要调用提供的接口重新链接符号</li>
<li>模块内部处理了<code>dlopen,dlsym</code>等函数，Hook模块可以拦截这些函数，然后调用提供的接口就可以恢复环境</li>
<li>内部提供手动重链接和系统重链接，手动重链接自己实现解析符号因此可以设置过滤项</li>
</ol>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过设置<code>LD_PRELOAD</code>环境变量一是执行时机问题，二是权限问题，三是某些符号无法拦截等缺陷，而我们手动更改设置全局库则不受这些影响，甚至可以控制指定模块，指定符号的Hook，只是内部解析符号和适配Android版本稍微麻烦一点。</p>
<p>上面代码分析可能有些乱，但是你只需要记住Android7.0以下全局库只需要设置<code>soinfo</code>的全局标志即可，Android7.0以上命名空间限制则还要要将全局库<code>soinfo</code>添加到所有命名空间即可，后续创建的命名空间必然继承全局库，然后因为执行时机问题一些库已经加载并链接了，因此我们要重新链接它的导入符号。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/Android%E6%BA%90%E7%A0%81/">Android源码</a>
                    
                      <a class="hover-with-bg" href="/blog/categories/Android-Hook/">Android Hook</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Android%E6%BA%90%E7%A0%81/">Android源码</a>
                    
                      <a class="hover-with-bg" href="/blog/tags/Android-Hook/">Android Hook</a>
                    
                      <a class="hover-with-bg" href="/blog/tags/PLT-Hook/">PLT Hook</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/02/20/fakexposed-principle-analyze/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">FakeXposed原理分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
    <!-- cnzz Analytics Icon -->
    <span id="cnzz_stat_icon_1280777274" style="display: none"></span>
  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/blog/js/local-search.js" ></script>



  
    <script  src="/blog/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  

















  

  

  

  

  

  
    <!-- cnzz Analytics -->
    <script defer src="//s4.cnzz.com/z_stat.php?id=1280777274&show=pic"
            type="text/javascript"></script>
  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>


</body>
</html>
